<div class="d-flex justify-content-between align-items-center text-center">
  <h4 class="text-center txt-propiedades">Propiedades</h4>
</div>

<div *ngIf="!propiedades || propiedades.length === 0" class="text-center mt-5">
  <i class="bi bi-house-slash text-muted" style="font-size: 3rem;"></i>
  <p class="text-muted mt-2">No hay propiedades registradas.</p>
</div>

<div class="scroll-container" *ngIf="propiedades && propiedades.length > 0">
  <div class="row g-4">
    <div class="col-md-4" *ngFor="let p of propiedades!">
      <div class="card card-propiedad shadow-sm h-100 border-0 rounded-4">
        <ng-container *ngIf="p.imagenes && p.imagenes.length > 0; else noImagen">
          <div class="scroll-images d-flex overflow-auto mb-2" style="scroll-snap-type: x mandatory;">
            <img *ngFor="let img of p.imagenes"
                 [src]="img"
                 class="d-block me-2"
                 style="height:120px; width:100%; min-width:100%; object-fit:contain; background-color:#f1f1f1; border-top-left-radius:1rem; border-top-right-radius:1rem; scroll-snap-align: start;">
          </div>
        </ng-container>

        <ng-template #noImagen>
          <div class="placeholder-img d-flex justify-content-center align-items-center" style="height:180px; background-color:#f1f1f1; border-top-left-radius:1rem; border-top-right-radius:1rem;">
            <i class="bi bi-image" style="font-size: 3rem;"></i>
          </div>
        </ng-template>

        <div class="card-body">
          <div class="row mb-1 align-items-center">
            <div class="col-auto d-flex align-items-center">
              <img *ngIf="p.propietario?.imageUrl; else defaultUserIcon"
                   [src]="p.propietario?.imageUrl"
                   class="rounded-circle me-1"
                   style="width: 24px; height: 24px; object-fit: cover;">
              <ng-template #defaultUserIcon>
                <i class="bi bi-person-circle me-1"></i>
              </ng-template>
              <span>{{ p.propietario?.username || 'Desconocido' }}</span>
            </div>

            <div class="col-auto ms-auto">
              <ng-container *ngIf="(p.promedio ?? 0) > 0; else noRating">
                <span class="rating d-flex align-items-center">
                  <i class="bi bi-star-fill me-1"></i>
                  {{ p.promedio | number:'1.1-1' }} / 5
                </span>
              </ng-container>
              <ng-template #noRating>
                <span class="rating text-muted small">Sin calificaciones</span>
              </ng-template>
            </div>
          </div>

          <div class="row mb-1 align-items-center mt-2">
            <div class="col-auto d-flex align-items-center">
              <i class="bi bi-house-door me-1 text-success"></i> {{ p.titulo }}
            </div>
            <div class="col-auto ms-auto">
              <span class="badge bg-warning text-dark">{{ p.tipo }}</span>
            </div>
          </div>

          <div class="row mb-1">
            <div class="col-12">
              <i class="bi bi-card-text me-1 text-secondary"></i>
              <p class="text-muted small mb-1 d-inline">{{ p.descripcion }}</p>
            </div>
          </div>

          <p><i class="bi bi-geo-alt-fill text-danger me-1 mt-2"></i> {{ p.ubicacion }}</p>

          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="precio">{{ p.precio | currency:'MXN':'symbol':'1.0-0' }}</span>
            <span><i class="bi bi-telephone me-1"></i>{{ p.propietario?.telefono || 'Sin Número Telefónico' }}</span>
          </div>

          <div class="card-footer-propiedad mt-2 d-flex flex-wrap gap-2">
            <button *ngIf="p.propietario?.id" class="btn btn-chat btn-primary" 
                    (click)="openChat({ 
                        id: p.propietario?.id!, 
                        username: p.propietario?.username!, 
                        imageUrl: p.propietario?.imageUrl 
                    })">
              <i class="bi bi-chat-dots"></i> Chat
            </button>

              <button class="btn btn-ver" (click)="verOpiniones(p.id)">
                <i class="bi bi-chat-left-text me-1"></i> Comentarios
              </button>
              <button *ngIf="!calificadoPropiedades.includes(p.id)" class="btn btn-opinar" (click)="openCalificar(p.id)">
                <i class="bi bi-star"></i> Calificar
              </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Comentarios + Enviar -->
<div class="modal fade" id="modalOpiniones" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Opiniones de la propiedad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body comentarios-body">
        <div *ngIf="comentarios.length === 0" class="text-center text-muted mb-3">
          <p>No hay comentarios aún.</p>
        </div>
        <div *ngFor="let c of comentarios" class="mb-3 border-bottom pb-2">
          <div class="d-flex align-items-center mb-1">
            <img *ngIf="c.imageUrl; else defaultUser" 
                 [src]="c.imageUrl" 
                 class="rounded-circle me-2" 
                 style="width: 30px; height: 30px; object-fit: cover;">
            <ng-template #defaultUser>
              <i class="bi bi-person-circle me-2" style="font-size:1.5rem;"></i>
            </ng-template>
            <strong>{{ c.username || 'Desconocido' }}</strong>
            <span class="ms-auto text-muted small">{{ c.fecha | date:'short' }}</span>
          </div>
          <p class="mb-0">{{ c.mensaje }}</p>
        </div>
      </div>

      <div class="modal-footer-comentario">
        <div class="d-flex w-100">
          <input type="text" class="form-control me-2" placeholder="Escribe un comentario..."
                 [(ngModel)]="nuevoComentario.mensaje">
          <button type="button" class="btn btn-send" (click)="guardarComentario()">
            <i class="bi bi-send-fill"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Calificar -->
<div class="modal fade" id="modalCalificar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content text-center">
      <div class="modal-header justify-content-center">
        <h5 class="modal-title">Calificar propiedad</h5>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-center mb-3">
          <i *ngFor="let s of [1,2,3,4,5]" 
             class="bi"
             [ngClass]="{
               'bi-star-fill text-warning': s <= estrellasSeleccionadas,
               'bi-star text-secondary': s > estrellasSeleccionadas
             }"
             style="font-size:2rem; cursor:pointer"
             (click)="seleccionarEstrellas(s)">
          </i>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-primary w-100" (click)="enviarCalificacion()">Enviar</button>
      </div>
    </div>
  </div>
</div>